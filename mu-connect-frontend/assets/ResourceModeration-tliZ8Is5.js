import{N as ue,u as p,h as je,j as s,C as I,b as j,d as o,B as l,F as M,K as T,H as B,S as me,A as he,n as fe,D as Y,I as Z,c as R,X as be,Z as ye,af as Ce,x as Se,ag as Re,ah as ve,z as we,E as Ae,O as _e,Q as ze,a6 as Fe,ai as Me}from"./chakra-CQE3Mdfe.js";import{u as Be,a as d}from"./react-DDk2FCmG.js";import{u as Le,V as ke,W as Pe,I as Ie,k as K,X as Te,Y as We,Z as J,$ as De,a0 as Ee,P as Oe,a1 as Ne,G as Ue,a2 as He,a3 as $e}from"./index-DPnEyPUk.js";import"./charts-BQajcoWg.js";const Qe=()=>{const x=ue(),W=Be(),{user:a}=Le(),ee=p("rgba(255, 255, 255, 0.92)","rgba(45, 55, 72, 0.85)"),D=p("rgba(226, 232, 240, 0.8)","rgba(74, 85, 104, 0.6)"),r=p("gray.600","gray.400"),E=p("blue.50","rgba(49, 130, 206, 0.12)"),se=p("rgba(226, 232, 240, 0.9)","rgba(74, 85, 104, 0.7)"),ie=p("rgba(237, 242, 247, 0.7)","rgba(45, 55, 72, 0.6)"),ne=p("rgba(203, 213, 224, 0.9)","rgba(74, 85, 104, 0.6)"),[m,O]=d.useState([]),[c,N]=d.useState({current_page:1,last_page:1,total:0}),[L,U]=d.useState(!0),[h,v]=d.useState(null),[t,H]=d.useState(null),[$,k]=d.useState(""),[w,A]=d.useState(""),{isOpen:q,onOpen:oe,onClose:te}=je(),_=()=>{te(),H(null),k(""),A("")},P=e=>e?Array.isArray(e)?e.map(i=>i==null?void 0:i.toLowerCase()).filter(Boolean):[String(e).toLowerCase()]:[],f=d.useMemo(()=>{const e=(localStorage.getItem("role")||"").toLowerCase(),i=P(a==null?void 0:a.roles),g=P(a==null?void 0:a.role_names),z=P(a==null?void 0:a.role),y=new Set([...i,...g,...z,e]);return y.has("admin")||y.has("moderator")},[a]),re=e=>{if(!e)return"Unknown";const i=new Date(String(e).replace(" ","T"));return Number.isNaN(i.getTime())?e:i.toLocaleString()},ae=e=>{if(!e)return"#";if(/^https?:\/\//i.test(e))return e;const i=Ue||"";return i?e.startsWith("/")?`${i}${e}`:`${i}/${e}`:e},le=e=>{const i=((e==null?void 0:e.type)||"").toLowerCase(),g=((e==null?void 0:e.mime_type)||"").toLowerCase();return i==="image"||g.startsWith("image")?Ee:i==="document"||g.includes("pdf")||g.includes("word")?Oe:Ne},de=e=>e?e.poll?e.poll:e.polls&&!Array.isArray(e.polls)?e.polls:null:null,b=d.useCallback(async(e=1)=>{if(f){U(!0);try{const i=await ke({page:e});O(Array.isArray(i==null?void 0:i.data)?i.data:[]),N({current_page:(i==null?void 0:i.current_page)||e,last_page:(i==null?void 0:i.last_page)||1,total:(i==null?void 0:i.total)||0})}catch(i){x({title:"Failed to load pending resources",description:(i==null?void 0:i.message)||(i==null?void 0:i.error)||"Please try again in a moment.",status:"error",duration:4e3,isClosable:!0})}finally{U(!1)}}},[f,x]);d.useEffect(()=>{a&&!f&&(x({title:"Access restricted",description:"You do not have permission to moderate resources.",status:"warning",duration:3e3,isClosable:!0}),W("/dashboard",{replace:!0}))},[a,f,W,x]),d.useEffect(()=>{b(1)},[b]);const ce=e=>{e<1||e>c.last_page||e===c.current_page||b(e)},V=e=>{O(i=>i.filter(g=>g.id!==e)),N(i=>({...i,total:Math.max((i.total||1)-1,0)}))},ge=async e=>{v(e);try{await He(e),V(e),x({title:"Resource approved",status:"success",duration:2500,isClosable:!0}),m.length<=1&&c.current_page>1&&b(c.current_page-1)}catch(i){x({title:"Approval failed",description:(i==null?void 0:i.message)||(i==null?void 0:i.error)||"Please try again.",status:"error",duration:3500,isClosable:!0})}finally{v(null)}},pe=e=>{H(e),k(""),A(""),oe()},xe=async()=>{const e=$.trim();if(!e){A("Please provide a reason for rejection.");return}if(t){v(t.id);try{await $e(t.id,e),V(t.id),x({title:"Resource rejected",status:"info",duration:2500,isClosable:!0}),_(),m.length<=1&&c.current_page>1&&b(c.current_page-1)}catch(i){x({title:"Rejection failed",description:(i==null?void 0:i.message)||(i==null?void 0:i.error)||"Please try again.",status:"error",duration:3500,isClosable:!0})}finally{v(null)}}};return f?s.jsxs(l,{position:"relative",bg:p("gray.50","gray.900"),minH:"calc(100vh - 60px)",py:6,px:{base:4,md:6,lg:8},children:[s.jsxs(M,{direction:"column",maxW:"1200px",mx:"auto",gap:6,children:[s.jsx(T,{size:"lg",children:"Resource Moderation"}),s.jsx(o,{color:r,maxW:"720px",children:"Review new resources submitted by the community. Approve high-quality contributions or reject those that do not meet the guidelines."}),s.jsxs(l,{bg:ee,borderRadius:"xl",border:"1px solid",borderColor:D,boxShadow:"sm",px:{base:4,md:6},py:6,children:[s.jsxs(B,{spacing:3,mb:4,color:r,children:[s.jsx(Ie,{size:20}),s.jsxs(o,{fontSize:"sm",children:[c.total," pending ",c.total===1?"resource":"resources"," in queue"]})]}),L?s.jsx(I,{py:16,children:s.jsx(me,{size:"lg",color:"blue.400",thickness:"4px"})}):m.length===0?s.jsxs(I,{py:20,flexDirection:"column",gap:3,children:[s.jsx(K,{size:36,color:"#48BB78"}),s.jsx(T,{size:"md",children:"All caught up!"}),s.jsx(o,{color:r,children:"No resources are waiting for review right now."})]}):s.jsx(j,{spacing:5,children:m.map(e=>{var i,g,z,y,X,G;return s.jsx(l,{borderRadius:"lg",border:"1px solid",borderColor:D,bg:p("white","gray.800"),p:{base:4,md:5},children:s.jsxs(M,{direction:{base:"column",md:"row"},gap:5,children:[s.jsxs(l,{flex:"1",children:[s.jsxs(B,{spacing:3,align:"flex-start",mb:3,children:[s.jsx(he,{size:"md",name:((i=e==null?void 0:e.user)==null?void 0:i.full_name)||((g=e==null?void 0:e.user)==null?void 0:g.username)||"User",src:((z=e==null?void 0:e.user)==null?void 0:z.avatar_url)||void 0}),s.jsxs(l,{children:[s.jsxs(B,{spacing:3,align:"center",children:[s.jsx(T,{size:"md",children:e.title||"Untitled"}),s.jsx(fe,{colorScheme:"yellow",textTransform:"capitalize",children:e.approval_status||"pending"})]}),s.jsxs(o,{fontSize:"sm",color:r,mt:1,children:["Submitted by ",((y=e==null?void 0:e.user)==null?void 0:y.full_name)||((X=e==null?void 0:e.user)==null?void 0:X.username)||"Unknown"]}),s.jsx(o,{fontSize:"xs",color:r,children:re(e.created_at)})]})]}),s.jsx(o,{color:p("gray.700","gray.200"),whiteSpace:"pre-wrap",children:e.description||"No description provided."}),s.jsx(Y,{my:4,opacity:.4}),s.jsxs(j,{direction:{base:"column",md:"row"},spacing:3,fontSize:"sm",color:r,children:[s.jsxs(l,{bg:E,borderRadius:"md",px:3,py:2,children:["Course: ",((G=e==null?void 0:e.course)==null?void 0:G.name)||"General"]}),s.jsxs(l,{bg:E,borderRadius:"md",px:3,py:2,children:["Attachments: ",Array.isArray(e.attachments)?e.attachments.length:0]})]}),Array.isArray(e.attachments)&&e.attachments.length>0&&s.jsxs(l,{mt:4,children:[s.jsx(o,{fontSize:"sm",fontWeight:"semibold",mb:2,children:"Attachments"}),s.jsx(j,{spacing:2,children:e.attachments.map(n=>{const C=le(n),S=ae(n==null?void 0:n.url);return s.jsxs(M,{align:"center",border:"1px solid",borderColor:se,borderRadius:"md",px:3,py:2,gap:3,children:[s.jsx(Z,{as:C,fontSize:"lg",color:"blue.400"}),s.jsxs(l,{flex:"1",minW:0,children:[s.jsx(o,{noOfLines:1,fontWeight:"medium",children:(n==null?void 0:n.original_name)||(n==null?void 0:n.name)||"Attachment"}),s.jsx(o,{fontSize:"xs",color:r,children:(n==null?void 0:n.mime_type)||(n==null?void 0:n.type)||"File"})]}),s.jsx(R,{as:be,href:S,isExternal:!0,variant:"ghost",size:"sm",leftIcon:s.jsx(Te,{}),children:"Open"})]},n.id||n.url)})})]}),(()=>{const n=de(e);if(!n)return null;const C=Array.isArray(n.options)?n.options:[],S=C.reduce((u,F)=>u+(F.vote_count||0),0);return s.jsxs(l,{mt:6,border:"1px solid",borderColor:ne,borderRadius:"lg",bg:ie,p:4,children:[s.jsxs(B,{spacing:2,mb:3,color:r,children:[s.jsx(Z,{as:We}),s.jsx(o,{fontWeight:"semibold",children:"Poll Question"})]}),s.jsx(o,{fontWeight:"bold",mb:3,children:n.question||"Poll"}),s.jsx(j,{spacing:3,children:C.length===0?s.jsx(o,{fontSize:"sm",color:r,children:"No poll options provided."}):C.map(u=>{const F=u.vote_count||0,Q=S>0?Math.round(F/S*100):0;return s.jsxs(l,{children:[s.jsxs(M,{justify:"space-between",fontSize:"sm",mb:1,children:[s.jsx(o,{fontWeight:"medium",children:u.option_text}),s.jsxs(o,{color:r,children:[F," votes"]})]}),s.jsx(ye,{value:Q,colorScheme:"blue",borderRadius:"md"}),s.jsxs(o,{fontSize:"xs",color:r,mt:1,children:[Q,"%"]})]},u.id||u.option_text)})}),s.jsxs(o,{fontSize:"xs",color:r,mt:3,children:["Total votes: ",S]})]})})()]}),s.jsx(Y,{orientation:"vertical",display:{base:"none",md:"block"}}),s.jsxs(j,{spacing:3,minW:{md:"220px"},children:[s.jsx(R,{colorScheme:"green",leftIcon:s.jsx(K,{}),isLoading:h===e.id,loadingText:"Approving",onClick:()=>ge(e.id),children:"Approve"}),s.jsx(R,{variant:"outline",colorScheme:"red",leftIcon:s.jsx(J,{}),isLoading:h===e.id&&(t==null?void 0:t.id)===e.id&&q,onClick:()=>pe(e),children:"Reject"})]})]})},e.id)})}),!L&&m.length>0&&s.jsx(De,{currentPage:c.current_page,totalPages:c.last_page,onPageChange:ce,isLoading:L})]})]}),s.jsxs(Ce,{isOpen:q,onClose:_,isCentered:!0,size:"lg",children:[s.jsx(Se,{}),s.jsxs(Re,{children:[s.jsx(ve,{children:"Reject resource"}),s.jsx(we,{disabled:h===(t==null?void 0:t.id),onClick:_}),s.jsx(Ae,{children:s.jsxs(_e,{isInvalid:!!w,children:[s.jsx(ze,{children:"Reason for rejection"}),s.jsx(Fe,{placeholder:"Describe why this resource is being rejected",value:$,onChange:e=>{k(e.target.value),w&&A("")},rows:5}),w&&s.jsx(o,{color:"red.500",fontSize:"sm",mt:2,children:w})]})}),s.jsxs(Me,{gap:3,children:[s.jsx(R,{variant:"ghost",onClick:_,isDisabled:h===(t==null?void 0:t.id),children:"Cancel"}),s.jsx(R,{colorScheme:"red",leftIcon:s.jsx(J,{}),onClick:xe,isLoading:h===(t==null?void 0:t.id),loadingText:"Rejecting",children:"Reject resource"})]})]})]})]}):s.jsx(I,{minH:"70vh",children:s.jsxs(j,{spacing:4,align:"center",children:[s.jsx(Pe,{size:48,color:"#DD6B20"}),s.jsx(o,{color:r,children:"Redirecting..."})]})})};export{Qe as default};

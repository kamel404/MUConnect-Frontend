import{N as Q,j as e,C as $,V as X,J as z,K as G,d as Z,S as ee,F as L,G as te,B as re,a1 as B,a2 as P,b as ae,O as x,Q as f,R as h,U as j,I as g,W as q,aH as k,$ as D,c as se}from"./chakra-CQE3Mdfe.js";import{a,u as oe,f as ie}from"./react-DDk2FCmG.js";import{u as ne,g as le,a as ce,b as ue,l as U,F as de,c as me,d as ge,e as pe,f as xe}from"./index-DPnEyPUk.js";import"./charts-BQajcoWg.js";const _e=()=>{const[r,b]=a.useState({username:"",faculty_id:"",major_id:"",temp_token:"",email:"",name:""}),[o,A]=a.useState({}),[H,Y]=a.useState([]),[N,E]=a.useState([]),[F,y]=a.useState(!0),[I,S]=a.useState(!1),[fe,he]=a.useState(!1),[O,_]=a.useState(!1),[V,R]=a.useState(!1),[w,C]=a.useState(null),[T,W]=a.useState(null),n=Q(),d=oe(),m=ie(),{completeGoogleSignUp:J,user:M}=ne();a.useEffect(()=>{var c;if((c=m.state)!=null&&c.temp_token)b(s=>({...s,temp_token:m.state.temp_token,email:m.state.email||"",name:m.state.name||""}));else{const s=le();if(!s){n({title:"Session expired",description:"Your registration session has expired or is invalid. Please start over.",status:"error",duration:5e3}),_(!0),setTimeout(()=>d("/login"),2e3);return}b(p=>({...p,temp_token:s}))}const t=1800*1e3,i=setInterval(()=>{const s=Math.max(0,t-(Date.now()-new Date().getTime()));if(s<=0){clearInterval(i),_(!0),n({title:"Session expired",description:"Your registration token has expired. Please start over.",status:"warning",duration:5e3}),d("/login");return}W(Math.floor(s/1e3/60))},6e4);return()=>clearInterval(i)},[m.state,d,n]),a.useEffect(()=>{y(!0),ce().then(t=>{Y(t),y(!1)}).catch(()=>{y(!1),n({title:"Failed to load faculties",description:"Please try refreshing the page.",status:"error",duration:5e3})})},[n]),a.useEffect(()=>{r.faculty_id?(S(!0),ue(r.faculty_id).then(t=>{E(t),S(!1)}).catch(()=>{S(!1),n({title:"Failed to load majors",description:"Please try selecting a different faculty.",status:"error",duration:5e3})})):E([])},[r.faculty_id,n]),a.useEffect(()=>{M&&d("/dashboard",{replace:!0})},[M,d]);const v=t=>{const{name:i,value:c}=t.target;b(s=>({...s,[i]:c})),o[i]&&A(s=>({...s,[i]:void 0}))},K=async t=>{var i,c,s,p;t.preventDefault(),R(!0),C(null);try{if(!r.username)throw new Error("Username is required");if(!r.faculty_id)throw new Error("Faculty selection is required");if(!r.major_id)throw new Error("Major selection is required");const u=((i=m.state)==null?void 0:i.temp_token)||localStorage.getItem("googleTempToken");if(!u)throw new Error("Registration token not found. Please try signing in with Google again.");const l=await J({temp_token:u,username:r.username,faculty_id:parseInt(r.faculty_id),major_id:parseInt(r.major_id)});console.log("Registration completed, response:",l),l&&l.token?(console.log("Sanctum token received from backend after registration"),localStorage.setItem("authToken",l.token)):console.warn("No Sanctum token found in registration response"),n({title:"Registration Complete!",description:"Your account has been created successfully.",status:"success",duration:5e3,isClosable:!0}),localStorage.removeItem("googleTempToken"),localStorage.removeItem("googleTokenExpiry"),d("/dashboard")}catch(u){console.error("Registration error:",u);const l=((s=(c=u.response)==null?void 0:c.data)==null?void 0:s.message)||u.message||"Failed to complete registration. Please try again.";C(l),(l.includes("expired")||l.includes("invalid")||((p=u.response)==null?void 0:p.status)===400)&&_(!0)}finally{R(!1)}};return O?e.jsx($,{minH:"100vh",bgGradient:"linear(to-br, blue.50 0%, white 50%, blue.50 100%)",children:e.jsxs(X,{spacing:6,children:[e.jsx(z,{src:U,boxSize:"80px",alt:"Maaref Logo"}),e.jsx(G,{size:"xl",color:"red.500",children:"Session Expired"}),e.jsx(Z,{children:"Redirecting to login page..."}),e.jsx(ee,{size:"md",color:"blue.500"})]})}):e.jsx(L,{minH:"100vh",bgGradient:"linear(to-br, blue.50 0%, white 50%, blue.50 100%)",align:"center",justify:"center",children:e.jsx(te,{maxW:"container.md",px:[4,8],children:e.jsxs(re,{bg:"white",p:[6,12],rounded:"2xl",shadow:"xl",position:"relative",_before:{content:'""',position:"absolute",top:"-4px",left:"-4px",right:"-4px",bottom:"-4px",bgGradient:"linear(to-r, blue.500, teal.400)",borderRadius:"2xl",zIndex:-1},children:[e.jsxs(L,{align:"center",mb:8,gap:3,justify:"center",children:[e.jsx(z,{src:U,boxSize:"50px",alt:"Maaref Logo"}),e.jsx(G,{size:"xl",bgGradient:"linear(to-r, blue.600, teal.500)",bgClip:"text",children:"Complete Your Registration"})]}),T!==null&&e.jsxs(B,{status:"info",mb:6,borderRadius:"md",children:[e.jsx(P,{}),"Please complete your registration within ",T," minutes."]}),e.jsx("form",{onSubmit:K,children:e.jsxs(ae,{spacing:6,children:[e.jsxs(x,{isReadOnly:!0,children:[e.jsx(f,{color:"gray.600",children:"Email"}),e.jsxs(h,{children:[e.jsx(j,{pointerEvents:"none",children:e.jsx(g,{as:de,color:"blue.500","aria-label":"Email icon"})}),e.jsx(q,{name:"email",value:r.email,placeholder:"your.email@mu.edu.lb",size:"lg",bg:"gray.50",focusBorderColor:"blue.500",color:"gray.600"})]})]}),e.jsxs(x,{isRequired:!0,isInvalid:!!o.username,children:[e.jsx(f,{color:"gray.600",children:"Username"}),e.jsxs(h,{children:[e.jsx(j,{pointerEvents:"none",children:e.jsx(g,{as:me,color:"blue.500","aria-label":"Username icon"})}),e.jsx(q,{name:"username",value:r.username,onChange:v,placeholder:"Choose a unique username",size:"lg",focusBorderColor:"blue.500",_placeholder:{color:"gray.400"},color:"gray.800"})]}),o.username&&e.jsx(k,{children:o.username})]}),e.jsxs(x,{isRequired:!0,isInvalid:!!o.faculty_id,children:[e.jsx(f,{color:"gray.600",children:"Faculty"}),e.jsxs(h,{children:[e.jsx(j,{pointerEvents:"none",children:e.jsx(g,{as:ge,color:"blue.500","aria-label":"Faculty icon"})}),e.jsx(D,{name:"faculty_id",value:r.faculty_id,onChange:v,placeholder:F?"Loading faculties...":"Select your faculty",size:"lg",focusBorderColor:"blue.500",color:"gray.800",isDisabled:F,children:H.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),o.faculty_id&&e.jsx(k,{children:o.faculty_id})]}),e.jsxs(x,{isRequired:!0,isInvalid:!!o.major_id,children:[e.jsx(f,{color:"gray.600",children:"Major"}),e.jsxs(h,{children:[e.jsx(j,{pointerEvents:"none",children:e.jsx(g,{as:pe,color:"blue.500","aria-label":"Major icon"})}),e.jsx(D,{name:"major_id",value:r.major_id,onChange:v,placeholder:r.faculty_id?I?"Loading majors...":"Select your major":"Select a faculty first",size:"lg",focusBorderColor:"blue.500",color:"gray.800",isDisabled:!r.faculty_id||I,children:N.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),o.major_id&&e.jsx(k,{children:o.major_id})]}),w&&e.jsxs(B,{status:"error",borderRadius:"md",children:[e.jsx(P,{}),w]}),e.jsx(se,{type:"submit",colorScheme:"blue",size:"lg",height:"60px",fontSize:"lg",rightIcon:e.jsx(g,{as:xe,"aria-label":"Complete"}),isLoading:V,loadingText:"Submitting",bgGradient:"linear(to-r, blue.500, teal.400)",_hover:{bgGradient:"linear(to-r, blue.600, teal.500)"},_active:{transform:"scale(0.98)"},children:"Complete Registration"})]})})]})})})};export{_e as default};

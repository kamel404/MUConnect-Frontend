import{N as h,j as o,C as p,V as f,J as b,K as x,B as k,S,d as c}from"./chakra-CQE3Mdfe.js";import{a as d,u as j,f as w}from"./react-DDk2FCmG.js";import{u as y,l as T,s as E}from"./index-DPnEyPUk.js";import"./charts-BQajcoWg.js";const R=()=>{const[t,a]=d.useState("processing"),s=j(),u=w(),r=h(),{handleGoogleAuthSuccess:g}=y();return d.useEffect(()=>{(async()=>{const i=new URLSearchParams(u.search);if(i.get("error")){r({title:"Authentication Error",description:i.get("error")||"Failed to authenticate with Google",status:"error",duration:5e3,isClosable:!0}),a("error"),setTimeout(()=>s("/login"),2e3);return}try{const n=i.get("data");console.log("Raw data from URL:",n);const e=JSON.parse(n||"{}");if(console.log("Parsed response data:",e),e.is_new_user)a("new-user"),E(e.temp_token),setTimeout(()=>{s("/complete-google-registration",{state:{email:e.email,name:e.name,temp_token:e.temp_token}})},1e3);else if(a("success"),console.log("Processing existing user login:",e),e.user){console.log("Token from response:",e.token);const m=e.token;m?(console.log("Sanctum token received from backend"),localStorage.setItem("authToken",m)):(console.error("No Sanctum token found in response - authentication may fail"),console.log("Response structure:",Object.keys(e))),e.user.faculty&&(localStorage.setItem("userFaculty",e.user.faculty.name),localStorage.setItem("faculty_id",e.user.faculty.id)),e.user.major&&(localStorage.setItem("userMajor",e.user.major.name),localStorage.setItem("major_id",e.user.major.id)),e.user.role_names&&e.user.role_names.length>0?localStorage.setItem("role",e.user.role_names[0]):e.user.roles&&e.user.roles.length>0&&localStorage.setItem("role",e.user.roles[0]);try{console.log("Updating auth context with user data"),await g(e.user),r({title:"Login Successful",description:e.message||"You have been logged in with Google",status:"success",duration:3e3,isClosable:!0}),console.log("Authentication successful, redirecting to dashboard"),setTimeout(()=>{const l=localStorage.getItem("authToken");console.log("Before redirect - Auth token exists:",!!l),s("/dashboard")},1500)}catch(l){console.error("Error updating auth context:",l),r({title:"Authentication Error",description:"Error setting up your user profile",status:"error",duration:5e3}),setTimeout(()=>s("/login"),2e3)}}else throw new Error("User data not found in response")}catch(n){console.error("Error processing Google callback:",n),a("error"),r({title:"Authentication Error",description:"Failed to process Google authentication",status:"error",duration:5e3,isClosable:!0}),setTimeout(()=>s("/login"),2e3)}})()},[u.search,s,r,g]),o.jsx(p,{minH:"100vh",bgGradient:"linear(to-br, blue.50 0%, white 50%, blue.50 100%)",children:o.jsxs(f,{spacing:6,children:[o.jsx(b,{src:T,boxSize:"80px",alt:"Maaref Logo"}),o.jsxs(x,{size:"xl",bgGradient:"linear(to-r, blue.600, teal.500)",bgClip:"text",children:[t==="processing"&&"Processing Authentication",t==="success"&&"Authentication Successful",t==="new-user"&&"Almost There!",t==="error"&&"Authentication Error"]}),o.jsxs(k,{children:[t==="processing"&&o.jsx(S,{size:"xl",color:"blue.500"}),t==="success"&&o.jsx(c,{children:"You will be redirected to the dashboard momentarily..."}),t==="new-user"&&o.jsx(c,{children:"Redirecting to complete your registration..."}),t==="error"&&o.jsx(c,{children:"Redirecting back to login page..."})]})]})})};export{R as default};
